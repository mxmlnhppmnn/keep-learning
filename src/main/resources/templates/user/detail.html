<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout}">
<main layout:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0" th:text="${@t.t('Benutzerdetails')}"></h1>

        <div>
            <a th:href="@{/share/list}"
            class="btn btn-outline-primary"
            th:text="${@t.t('Freigaben')}">
            </a>
            <a th:href="@{/chat/list}"
            class="btn btn-outline-primary"
            th:text="${@t.t('Chats')}">
            </a>
            <a th:href="@{/user/view/{id}(id=${user.id})}"
            class="btn btn-primary"
            th:text="${@t.t('Öffentliches Profil')}">
            </a>
        </div>
    </div>

    <form th:action="@{/user/bearbeiten}" method="post"
        enctype="multipart/form-data" id="benutzerBearbeitenForm" class="row">

        <div class="col-12">
            <label class="ms-2" th:text="${@t.t('Name')}"></label>
            <input type="text" name="name" class="form-control" th:value="${user.name}" required>
        </div>

    </form>

    <div class="mt-2">
        <label class="ms-2" th:text="${@t.t('Email')}"></label>
        <div class="form-control" th:text="${user.email}"></div>
    </div>

    <a th:href="@{/user/edit-password}" class="btn btn-outline-primary me-2 mt-3" th:text="${@t.t('Passwort Ändern')}"></a>

    <div class="mt-3">

        <button type="submit" form="benutzerBearbeitenForm" class="btn btn-primary"
            th:text="${@t.t('Änderungen speichern')}">
        </button>

    </div>

    <hr>

    <div th:if="${googleMessage}" class="alert alert-info">
        <span th:text="${googleMessage}"></span>
    </div>

    <div class="mt-3">

        <!-- Wenn NICHT verbunden -->
        <a sec:authorize="hasRole('TEACHER')" th:if="${!googleConnected}"
            th:href="@{/google/oauth/connect(userId=${user.id})}" class="btn btn-primary"
            th:text="${@t.t('Mit Google Calendar verbinden')}">
        </a>

        <!-- Wenn verbunden -->
        <div th:if="${googleConnected}">
            <span class="badge bg-success" th:text="${@t.t('Google Calendar verbunden ✓')}"></span>

            <a th:href="@{/google/oauth/connect(userId=${user.id})}" class="btn btn-outline-primary ms-2"
                th:text="${@t.t('Erneut verbinden')}">
            </a>
        </div>

        <hr sec:authorize="hasRole('TEACHER')">

        <h3 sec:authorize="hasRole('TEACHER')" th:text="${@t.t('Gib an, wann du Zeit hast zu unterrichten!')}">
        </h3>

        <a sec:authorize="hasRole('TEACHER')"
            th:href="@{/lehrer/{id}/verfuegbarkeit(id=${#authentication.principal.id})}" class="btn btn-primary"
            th:text="${@t.t('Verfügbarkeit verwalten')}">
        </a>
    </div>

    <hr>

    <h3 th:text="${@t.t('Verifizierung')}"></h3>

    <!-- Antrag stellen -->
    <div th:if="${!user.verified and !hasPending}">
        <form th:action="@{/user/verification}" method="post" enctype="multipart/form-data" th:csrf>

            <label th:text="${@t.t('Nachweis (PDF oder Bild):')}"></label>
            <input type="file" name="document" required>

            <button type="submit" class="btn btn-primary" th:text="${@t.t('Jetzt verifizieren')}">
            </button>
        </form>
    </div>

    <!-- verifiziert -->
    <div th:if="${user.verified}">
        <p th:text="${@t.t('Dein Account ist verifiziert.')}"></p>
    </div>

    <!-- Antrag läuft -->
    <div th:if="${!user.verified and hasPending}">
        <p th:text="${@t.t('Dein Verifizierungsantrag wird geprüft.')}"></p>
    </div>

    <!-- Abgelehnt -->
    <div th:if="${!user.verified and !hasPending and rejectedRequest != null}">
        <p style="color: red;" th:text="${@t.t('Dein Verifizierungsantrag wurde abgelehnt.')}">
        </p>
        <p>
            <strong th:text="${@t.t('Grund:')}"></strong>
            <span th:text="${rejectedRequest.rejectionReason}"></span>
        </p>
    </div>

</main>

</html>